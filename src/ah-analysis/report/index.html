<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asian Handicap Strategy Analysis Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            border: '#334155'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-900 text-slate-100 h-screen overflow-hidden">
    <div class="h-full flex flex-col">
        <!-- Header -->
        <div class="bg-slate-800 border-b border-slate-700 px-4 py-2 flex-shrink-0">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-white">Asian Handicap Strategy Analysis</h1>
                    <div id="metadata" class="text-slate-400 text-xs space-x-4">
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
            <!-- Rankings Info -->
            <div class="mt-2 text-xs text-slate-300">
                <span>üìä Multi-criteria scoring: Statistical + Sample Size + ROI + Complexity + Sharpe + Feasibility</span>
                <span class="ml-4" id="rankingsInfo">Loading rankings...</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 grid grid-cols-1 lg:grid-cols-[30%_70%] h-full overflow-hidden">
            <!-- Left Panel - Strategy List -->
            <div class="bg-slate-800 border-r border-slate-700 flex flex-col overflow-hidden">
                <div class="px-3 py-2 bg-slate-700 border-b border-slate-600 flex-shrink-0">
                    <h2 class="text-lg font-semibold text-white">Strategies</h2>
                    <p class="text-slate-300 text-xs">Sorted by multi-criteria score ‚Ä¢ Tier and rank shown ‚Ä¢ Click to view details</p>
                    <!-- Filter Controls -->
                    <div class="mt-2 flex items-center space-x-2 flex-wrap">
                        <label for="minBetsFilter" class="text-slate-300 text-xs font-medium">Min Bets:</label>
                        <input 
                            type="number" 
                            id="minBetsFilter" 
                            class="bg-slate-600 text-white text-xs px-2 py-1 rounded border border-slate-500 focus:border-blue-400 focus:outline-none w-16" 
                            placeholder="0" 
                            min="0" 
                            value="0"
                            onchange="applyFilters()"
                        >
                        <label for="tierFilter" class="text-slate-300 text-xs font-medium ml-2">Tier:</label>
                        <select 
                            id="tierFilter" 
                            class="bg-slate-600 text-white text-xs px-2 py-1 rounded border border-slate-500 focus:border-blue-400 focus:outline-none"
                            onchange="applyFilters()"
                        >
                            <option value="">All</option>
                            <option value="1">Tier 1</option>
                            <option value="2">Tier 2</option>
                            <option value="3">Other</option>
                        </select>
                        <span id="filteredCount" class="text-slate-400 text-xs"></span>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <div id="strategyList" class="divide-y divide-slate-700">
                        <!-- Strategies will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Right Panel - Strategy Details -->
            <div class="bg-slate-800 flex flex-col overflow-hidden">
                <div class="px-3 py-2 bg-slate-700 border-b border-slate-600 flex-shrink-0">
                    <h2 class="text-lg font-semibold text-white">Strategy Details</h2>
                    <p id="selectedStrategy" class="text-slate-300 text-xs">Select a strategy to view details</p>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <div id="strategyDetails" class="p-2 text-slate-400 text-center text-sm">
                        Select a strategy from the left panel to view detailed betting records
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let strategiesData = null;
        let allStrategies = null;
        let rankingsData = null;

        // Function to apply filters to strategies
        function applyFilters() {
            if (!allStrategies || !strategiesData) return;
            
            const minBets = parseInt(document.getElementById('minBetsFilter').value) || 0;
            const tierFilter = document.getElementById('tierFilter')?.value || '';
            
            // Filter strategies based on minimum bets and tier
            const filteredStrategies = allStrategies.filter(strategy => {
                const totalBets = parseInt(strategy.totalBets) || 0;
                const ranking = rankingLookup[strategy.name];
                const strategyTier = ranking?.tier || '3';
                
                // Apply minimum bets filter
                if (totalBets < minBets) return false;
                
                // Apply tier filter if selected
                if (tierFilter && strategyTier !== tierFilter) return false;
                
                return true;
            });
            
            // Update the filtered count display
            const totalCount = allStrategies.length;
            const filteredCount = filteredStrategies.length;
            const profitableCount = filteredStrategies.filter(s => parseFloat(s.roi.replace('%', '')) > 0).length;
            const recommendedCount = filteredStrategies.filter(s => rankingLookup[s.name]?.recommended).length;
            
            document.getElementById('filteredCount').textContent = 
                `(${filteredCount}/${totalCount}, ${profitableCount} profitable, ${recommendedCount} ‚≠ê)`;
            
            // Update metadata and display filtered strategies
            displayMetadata(strategiesData.metadata, filteredStrategies);
            displayStrategies(filteredStrategies);
        }

        // Function to convert strategy names to Start Case (Title Case)
        function toStartCase(str) {
            return str
                .replace(/([a-z])([A-Z])/g, '$1 $2') // Add space before capital letters
                .replace(/_/g, ' ') // Replace underscores with spaces
                .replace(/\b\w/g, l => l.toUpperCase()) // Capitalize first letter of each word
                .replace(/\s+/g, ' ') // Remove extra spaces
                .trim();
        }

        // Function to determine strategy type from name
        function getStrategyType(name) {
            if (name.startsWith('Single_')) {
                return 'Single Factor';
            } else if (name.startsWith('Adaptive_Adaptive_')) {
                return 'Double Adaptive';
            } else if (name.startsWith('Adaptive_CrossRule_')) {
                return 'Adaptive Cross-Rule';
            } else if (name.startsWith('Adaptive_Single_')) {
                return 'Adaptive Single';
            } else if (name.startsWith('Adaptive_Ratio_')) {
                return 'Adaptive Ratio';
            } else if (name.startsWith('CrossRule_')) {
                return 'Cross-Rule';
            } else if (name.startsWith('Heavy_')) {
                return 'Heavy Favorite/Underdog';
            } else if (name.startsWith('Late_Season_')) {
                return 'Late Season Timing';
            } else if (name.startsWith('Early_Season_')) {
                return 'Early Season Timing';
            } else if (name.startsWith('Mid_Season_')) {
                return 'Mid Season Timing';
            } else if (name.includes('_Momentum_')) {
                return 'Momentum Strategy';
            } else if (name.includes('_Position_')) {
                return 'Position Strategy';
            } else if (name.includes('_Market_')) {
                return 'Market Efficiency';
            } else if (name.includes('_AH_')) {
                return 'AH Specific';
            } else if (name.includes('Goal_Difference')) {
                return 'Goal Difference';
            } else if (name.includes('Form_')) {
                return 'Form Strategy';
            } else if (name.includes('Rescue')) {
                return 'Rescue Strategy';
            } else {
                return 'Complex Strategy';
            }
        }

        // Initialize rankings after data is available
        function initializeRankings() {
            rankingLookup = createRankingLookup();
        }

        // Display rankings information in header
        function displayRankingsInfo() {
            const recommendedCount = embeddedRankingsData.topStrategies.filter(s => s.recommended).length;
            const tier1Count = embeddedRankingsData.topStrategies.filter(s => s.tier === '1').length;
            const tier2Count = embeddedRankingsData.topStrategies.filter(s => s.tier === '2').length;
            
            document.getElementById('rankingsInfo').innerHTML = `
                <span class="text-green-400">‚≠ê ${recommendedCount} recommended</span>
                <span class="ml-2 text-green-400">Tier 1: ${tier1Count}</span>
                <span class="ml-2 text-yellow-400">Tier 2: ${tier2Count}</span>
                <span class="ml-2 text-slate-400">Total analyzed: ${embeddedRankingsData.totalStrategies}</span>
            `;
        }

        // Load and display strategies
        async function loadStrategies() {
            try {
                // Initialize rankings lookup after embeddedRankingsData is available
                initializeRankings();
                
                const response = await fetch('../results/summary.json');
                const data = await response.json();
                strategiesData = data;
                allStrategies = data.strategies;
                
                displayMetadata(data.metadata);
                displayRankingsInfo(); // Display rankings summary
                applyFilters(); // Apply initial filters (will show all strategies since min bet is 0)
            } catch (error) {
                console.error('Error loading strategies:', error);
                document.getElementById('strategyList').innerHTML = 
                    '<div class="p-4 text-red-400">Error loading strategies data</div>';
                document.getElementById('rankingsInfo').innerHTML = 
                    '<span class="text-red-400">Error loading rankings</span>';
            }
        }

        function displayMetadata(metadata, filteredStrategies = null) {
            if (filteredStrategies) {
                // Calculate filtered metadata
                const totalFiltered = filteredStrategies.length;
                const profitableFiltered = filteredStrategies.filter(s => parseFloat(s.roi.replace('%', '')) > 0).length;
                const bestROIFiltered = filteredStrategies.length > 0 ? 
                    Math.max(...filteredStrategies.map(s => parseFloat(s.roi.replace('%', '')))) : 0;
                
                document.getElementById('metadata').innerHTML = `
                    <span>Showing: <strong class="text-white">${totalFiltered}</strong> / ${metadata.totalStrategies}</span>
                    <span>Profitable: <strong class="text-green-400">${profitableFiltered}</strong></span>
                    <span>Best ROI: <strong class="text-green-400">${bestROIFiltered.toFixed(2)}%</strong></span>
                    <span>Updated: <strong class="text-white">${new Date(metadata.generatedAt).toLocaleDateString()}</strong></span>
                `;
            } else {
                // Original metadata display
                document.getElementById('metadata').innerHTML = `
                    <span>Total: <strong class="text-white">${metadata.totalStrategies}</strong></span>
                    <span>Profitable: <strong class="text-green-400">${metadata.profitableStrategies}</strong></span>
                    <span>Best ROI: <strong class="text-green-400">${metadata.bestROI}%</strong></span>
                    <span>Updated: <strong class="text-white">${new Date(metadata.generatedAt).toLocaleDateString()}</strong></span>
                `;
            }
        }

        function displayStrategies(strategies) {
            const listElement = document.getElementById('strategyList');
            
            // Sort strategies by multi-criteria ranking first (lowest rank number = best), then by ROI
            const sortedStrategies = [...strategies].sort((a, b) => {
                const rankA = rankingLookup[a.name]?.rank || 999;
                const rankB = rankingLookup[b.name]?.rank || 999;
                
                if (rankA !== rankB) {
                    return rankA - rankB; // Lower rank number first (rank 1 beats rank 2)
                }
                
                // If same rank or both unranked, sort by ROI
                const roiA = parseFloat(a.roi.replace('%', ''));
                const roiB = parseFloat(b.roi.replace('%', ''));
                return roiB - roiA; // Higher ROI first
            });
            
            listElement.innerHTML = sortedStrategies.map((strategy, index) => {
                const roiValue = parseFloat(strategy.roi.replace('%', ''));
                const roiColor = roiValue >= 0 ? 'text-green-400' : 'text-red-400';
                const correlationValue = parseFloat(strategy.correlation) || 0;
                
                // Get ranking info
                const ranking = rankingLookup[strategy.name];
                const rankText = ranking ? `#${ranking.rank}` : 'Unranked';
                const tierText = ranking ? getTierText(ranking.tier) : 'Tier 3';
                const scoreText = ranking ? `${ranking.totalScore}/100` : 'N/A';
                const gradeText = ranking ? ranking.grade : 'N/A';
                const isRecommended = ranking?.recommended || false;
                
                // Colors based on ranking
                const rankColor = ranking ? (ranking.rank <= 6 ? 'text-yellow-400' : 'text-blue-400') : 'text-slate-400';
                const tierColor = getTierColor(ranking?.tier || '3');
                const gradeColor = ranking ? getGradeColor(ranking.grade) : 'text-slate-400';
                
                return `
                    <div class="strategy-item px-3 py-2 hover:bg-slate-700 cursor-pointer transition-colors duration-150 border-l-2 ${isRecommended ? 'border-l-green-500' : 'border-transparent'} hover:border-l-blue-500" 
                         onclick="loadStrategyDetails('${strategy.name}', '${strategy.detailsFile}', this)">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-medium text-white text-xs truncate pr-2 leading-tight" title="${strategy.name}">
                                ${isRecommended ? '‚≠ê ' : ''}${toStartCase(strategy.name)}
                            </h3>
                            <span class="text-xs ${roiColor} font-bold whitespace-nowrap">${strategy.roi}</span>
                        </div>
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs ${rankColor} font-bold">${rankText}</span>
                                <span class="text-xs ${tierColor} font-medium">${tierText}</span>
                                <span class="text-xs ${gradeColor} font-medium">${gradeText}</span>
                            </div>
                            <span class="text-xs text-slate-500">${strategy.totalBets} bets</span>
                        </div>
                        <div class="grid grid-cols-4 gap-1 text-xs text-slate-400 mb-1">
                            <div>Score: ${scoreText}</div>
                            <div>W: ${strategy.winRate}</div>
                            <div>C: ${strategy.correlation}</div>
                            <div>F: ${strategy.factors.length}</div>
                        </div>
                        <div class="text-xs text-slate-500 truncate leading-tight">
                            ${strategy.hypothesis}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function loadStrategyDetails(strategyName, detailsFile, clickedElement) {
            try {
                // Update selected strategy display
                document.getElementById('selectedStrategy').textContent = `Loading ${toStartCase(strategyName)}...`;
                
                // Highlight selected strategy
                document.querySelectorAll('.strategy-item').forEach(item => {
                    item.classList.remove('bg-slate-700', 'border-l-blue-500');
                    item.classList.add('border-l-transparent');
                });
                if (clickedElement) {
                    clickedElement.classList.add('bg-slate-700', 'border-l-blue-500');
                    clickedElement.classList.remove('border-l-transparent');
                }
                
                // Load betting records
                const response = await fetch(`../results/${detailsFile}`);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        displayMissingFile(strategyName, detailsFile);
                        document.getElementById('selectedStrategy').textContent = `${toStartCase(strategyName)} (Details Missing)`;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return;
                }
                
                const data = await response.json();
                
                displayStrategyDetails(data);
                document.getElementById('selectedStrategy').textContent = toStartCase(strategyName);
                
            } catch (error) {
                console.error('Error loading strategy details:', error);
                document.getElementById('strategyDetails').innerHTML = 
                    `<div class="p-4 text-red-400">Error loading strategy details: ${error.message}</div>`;
                document.getElementById('selectedStrategy').textContent = `${toStartCase(strategyName)} (Error)`;
            }
        }

        function displayMissingFile(strategyName, detailsFile) {
            const strategy = strategiesData.strategies.find(s => s.name === strategyName);
            const detailsElement = document.getElementById('strategyDetails');
            
            detailsElement.innerHTML = `
                <div class="p-2">
                    <div class="bg-yellow-900/50 border border-yellow-600 rounded p-2 mb-2">
                        <div class="flex items-center">
                            <span class="text-yellow-400 text-sm mr-2">‚ö†Ô∏è</span>
                            <h3 class="text-yellow-200 font-medium text-sm">Records Missing</h3>
                        </div>
                        <p class="text-yellow-300 text-xs mt-1">
                            File <code class="bg-yellow-800 px-1 rounded text-xs">${detailsFile}</code> not found.
                        </p>
                    </div>
                    
                    <!-- Performance & Info Row -->
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <!-- Performance Metrics -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">üìä Performance</h4>
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">ROI</td>
                                        <td class="py-1 text-green-400 font-bold">${strategy.roi}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Correlation</td>
                                        <td class="py-1 text-blue-400 font-medium">${strategy.correlation}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Total Bets</td>
                                        <td class="py-1 text-white font-medium">${strategy.totalBets}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Win Rate</td>
                                        <td class="py-1 text-white font-medium">${strategy.winRate}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Avg Profit/Bet</td>
                                        <td class="py-1 text-white font-medium">${strategy.avgProfitPerBet || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 text-slate-400 font-medium">Valid Samples</td>
                                        <td class="py-1 text-white font-medium">${strategy.validSamples || 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Generation Info -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">üïí Info</h4>
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Generated</td>
                                        <td class="py-1 text-slate-300">${new Date(strategy.generatedAt).toLocaleDateString()}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 text-slate-400 font-medium">Threshold</td>
                                        <td class="py-1 text-slate-300">${strategy.threshold || 'Dynamic'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Definition & Factors Row -->
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <!-- Strategy Definition -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">üéØ Definition</h4>
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium w-16">Type</td>
                                        <td class="py-1 text-blue-400 font-medium">${getStrategyType(strategy.name)}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium align-top">Hypothesis</td>
                                        <td class="py-1 text-slate-300 bg-slate-600 rounded px-2">${strategy.hypothesis}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 text-slate-400 font-medium align-top">Name</td>
                                        <td class="py-1 text-slate-300 font-mono bg-slate-600 rounded px-2 break-all" title="${strategy.name}">${toStartCase(strategy.name)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Factor Analysis -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">‚ö° Factors (${strategy.factors.length})</h4>
                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                ${strategy.factors.map((factor, index) => `
                                    <div class="bg-slate-600 p-1 rounded">
                                        <div class="text-xs text-slate-400">Factor ${index + 1}:</div>
                                        <code class="text-green-300 text-xs break-all">${factor}</code>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function displayStrategyDetails(data) {
            const detailsElement = document.getElementById('strategyDetails');
            
            // Find the strategy from the summary data to get complete information
            const summaryStrategy = strategiesData.strategies.find(s => s.name === data.strategy.name);
            
            // Strategy info section with comprehensive details
            const strategyInfo = `
                <div class="p-2">
                    <!-- Performance & Info Row -->
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <!-- Performance Metrics -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">üìä Performance</h4>
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">ROI</td>
                                        <td class="py-1 text-green-400 font-bold">${data.strategy.roi}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Correlation</td>
                                        <td class="py-1 text-blue-400 font-medium">${data.strategy.correlation}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Total Bets</td>
                                        <td class="py-1 text-white font-medium">${data.summary.totalBets}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Win Rate</td>
                                        <td class="py-1 text-white font-medium">${data.summary.winRate}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Total Profit</td>
                                        <td class="py-1 text-white font-medium">${data.summary.totalProfit}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Total Staked</td>
                                        <td class="py-1 text-blue-400 font-medium">${data.summary.totalStaked || 'N/A'}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 text-slate-400 font-medium">Avg Profit/Bet</td>
                                        <td class="py-1 text-white font-medium">${summaryStrategy?.avgProfitPerBet || 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Generation Info -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">üïí Info</h4>
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium">Generated</td>
                                        <td class="py-1 text-slate-300">${new Date(data.summary.generatedAt).toLocaleDateString()}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 text-slate-400 font-medium">Valid Samples</td>
                                        <td class="py-1 text-slate-300">${summaryStrategy?.validSamples || 'N/A'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Definition & Factors Row -->
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <!-- Strategy Definition -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">üéØ Definition</h4>
                            <table class="w-full text-xs">
                                <tbody>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium w-16">Type</td>
                                        <td class="py-1 text-blue-400 font-medium">${getStrategyType(data.strategy.name)}</td>
                                    </tr>
                                    <tr class="border-b border-slate-600">
                                        <td class="py-1 text-slate-400 font-medium align-top">Hypothesis</td>
                                        <td class="py-1 text-slate-300 bg-slate-600 rounded px-2">${data.strategy.hypothesis}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-1 text-slate-400 font-medium align-top">Name</td>
                                        <td class="py-1 text-slate-300 font-mono bg-slate-600 rounded px-2 break-all" title="${data.strategy.name}">${toStartCase(data.strategy.name)}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Factor Analysis -->
                        <div class="bg-slate-700 rounded p-2">
                            <h4 class="text-white font-medium text-sm mb-2">‚ö° Factors (${data.strategy.factors.length})</h4>
                            <div class="space-y-1 max-h-32 overflow-y-auto">
                                ${data.strategy.factors.map((factor, index) => `
                                    <div class="bg-slate-600 p-1 rounded">
                                        <div class="text-xs text-slate-400">Factor ${index + 1}:</div>
                                        <code class="text-green-300 text-xs break-all">${factor}</code>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Betting records table
            const records = data.bettingRecords; // Show all records
            const recordsTable = `
                <div class="p-2 border-t border-slate-700">
                    <h4 class="text-white font-medium text-sm mb-2">üìà Records (${records.length})</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-xs">
                            <thead>
                                <tr class="text-slate-400 border-b border-slate-600">
                                    <th class="text-left py-1 px-1">Date</th>
                                    <th class="text-left py-1 px-1">Match</th>
                                    <th class="text-left py-1 px-1">Score</th>
                                    <th class="text-left py-1 px-1">Line</th>
                                    <th class="text-left py-1 px-1">Side</th>
                                    <th class="text-left py-1 px-1">Odds</th>
                                    <th class="text-right py-1 px-1">Bet Size</th>
                                    <th class="text-left py-1 px-1">Result</th>
                                    <th class="text-right py-1 px-1">P/L</th>
                                    <th class="text-left py-1 px-1">Factor</th>
                                    <th class="text-left py-1 px-1">Calculation</th>
                                    <th class="text-left py-1 px-1">Threshold</th>
                                    <th class="text-left py-1 px-1">Met</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-700">
                                ${records.map(record => {
                                    const profitValue = parseFloat(record.profit);
                                    const profitColor = profitValue > 0 ? 'text-green-400' : 
                                                       profitValue < 0 ? 'text-red-400' : 'text-slate-400';
                                    const outcomeColor = record.outcome === 'Win' ? 'text-green-400' : 
                                                        record.outcome === 'Loss' ? 'text-red-400' : 
                                                        record.outcome.includes('Half') ? 'text-yellow-400' : 'text-slate-400';
                                    
                                    // Factor calculation display
                                    const factorCalc = record.factorCalculation ? 
                                        record.factorCalculation.map(calc => {
                                            // Simplify the expression display
                                            let simplifiedExpression = calc.expression;
                                            if (simplifiedExpression.includes('?') && simplifiedExpression.includes(':')) {
                                                // Extract the result part and simplify
                                                const parts = simplifiedExpression.split('?');
                                                if (parts.length === 2) {
                                                    const result = parts[1].trim();
                                                    simplifiedExpression = `factor ${result}`;
                                                }
                                            }
                                            
                                            return `<div class="text-xs bg-slate-600 p-1 rounded mb-1">
                                                <div class="text-green-300" title="${calc.expression}">${simplifiedExpression}</div>
                                                <div class="text-slate-300">Val: ${calc.calculatedValue}</div>
                                                <div class="text-slate-400">${calc.explanation}</div>
                                            </div>`
                                        }).join('') : 'N/A';
                                    
                                    const thresholdColor = record.thresholdMet ? 'text-green-400' : 'text-red-400';
                                    
                                    return `
                                        <tr class="hover:bg-slate-700/50">
                                            <td class="py-1 px-1 text-slate-300">${new Date(record.date).toLocaleDateString('en-US', {year:'2-digit', month:'short', day:'numeric'})}</td>
                                            <td class="py-1 px-1 text-slate-300 text-xs" title="${record.homeTeam} vs ${record.awayTeam}">${record.homeTeam} vs ${record.awayTeam}</td>
                                            <td class="py-1 px-1 text-slate-300">${record.score}</td>
                                            <td class="py-1 px-1 text-slate-300">${record.handicapLine}</td>
                                            <td class="py-1 px-1 text-slate-300">${record.betSide.charAt(0)}</td>
                                            <td class="py-1 px-1 text-slate-300">${record.betOdds}</td>
                                            <td class="py-1 px-1 text-right text-blue-400 font-medium">$${record.betSize || 'N/A'}</td>
                                            <td class="py-1 px-1 ${outcomeColor}">${record.outcome.charAt(0)}</td>
                                            <td class="py-1 px-1 text-right ${profitColor} font-medium">${record.profit}</td>
                                            <td class="py-1 px-1 text-yellow-400 font-medium">${record.factorValue}</td>
                                            <td class="py-1 px-1 max-w-48 overflow-hidden">${factorCalc}</td>
                                            <td class="py-1 px-1 text-slate-300 text-xs">${record.threshold}<br><span class="text-slate-500">${record.thresholdType}</span></td>
                                            <td class="py-1 px-1 ${thresholdColor} font-bold">${record.thresholdMet ? '‚úì' : '‚úó'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            detailsElement.innerHTML = strategyInfo + recordsTable;
        }

        // Create a mapping from strategy name to ranking info for quick lookup
        function createRankingLookup() {
            const lookup = {};
            if (embeddedRankingsData && embeddedRankingsData.topStrategies) {
                embeddedRankingsData.topStrategies.forEach(strategy => {
                    lookup[strategy.name] = {
                        rank: strategy.rank,
                        tier: strategy.tier,
                        totalScore: strategy.totalScore,
                        grade: strategy.grade,
                        recommended: strategy.recommended
                    };
                });
            }
            return lookup;
        }
        
        // Will initialize after embeddedRankingsData is defined
        let rankingLookup = {};

        // Embedded rankings data to avoid CORS issues when opening file directly
        const embeddedRankingsData = {
  "generatedAt": "2025-01-28T00:00:00Z",
  "totalStrategies": 92,
  "scoringCriteria": {
    "statistical": "Statistical significance (t-test) - 0-25 pts",
    "sampleSize": "Number of betting opportunities - 0-20 pts", 
    "roi": "Return on investment sustainability - 0-20 pts",
    "complexity": "Rule simplicity and interpretability - 0-15 pts",
    "sharpe": "Risk-adjusted performance - 0-10 pts",
    "feasibility": "Implementation practicality - 0-10 pts"
  },
  "gradeScale": {
    "A+": "85-100 points (Exceptional)",
    "A": "75-84 points (Excellent)", 
    "B+": "65-74 points (Very Good)",
    "B": "55-64 points (Good)",
    "C+": "45-54 points (Fair)",
    "C": "35-44 points (Poor)",
    "D": "<35 points (Avoid)"
  },
  "topStrategies": [
    {
      "rank": 1,
      "name": "Single_topSixBattle",
      "totalScore": 67,
      "grade": "B+",
      "roi": 12.35,
      "totalBets": 149,
      "winRate": 57.0,
      "sharpeRatio": 0.126,
      "recommended": true,
      "tier": "2",
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 20,
        "complexity": 15,
        "sharpe": 7,
        "feasibility": 10
      }
    },
    {
      "rank": 2,
      "name": "Single_ahSlightFavorite", 
      "totalScore": 65,
      "grade": "B+",
      "roi": 13.03,
      "totalBets": 183,
      "winRate": 62.8,
      "sharpeRatio": 0.084,
      "recommended": true,
      "tier": "2",
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 20,
        "complexity": 15,
        "sharpe": 5,
        "feasibility": 10
      }
    },
    {
      "rank": 3,
      "name": "Single_fadeAllSeasonQuarterFavorites",
      "totalScore": 65,
      "grade": "B+", 
      "roi": 12.35,
      "totalBets": 175,
      "winRate": 62.9,
      "sharpeRatio": 0.088,
      "recommended": true,
      "tier": "2",
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 20,
        "complexity": 15,
        "sharpe": 5,
        "feasibility": 10
      }
    },
    {
      "rank": 4,
      "name": "Single_alwaysBetAwayTopSix",
      "totalScore": 65,
      "grade": "B+",
      "roi": 12.19,
      "totalBets": 278,
      "winRate": 55.0,
      "sharpeRatio": 0.107,
      "recommended": true,
      "tier": "1",
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 20,
        "complexity": 15,
        "sharpe": 7,
        "feasibility": 8
      }
    },
    {
      "rank": 5,
      "name": "Single_awayTopSix",
      "totalScore": 65,
      "grade": "B+",
      "roi": 10.66,
      "totalBets": 299,
      "winRate": 54.8,
      "sharpeRatio": 0.103,
      "recommended": true,
      "tier": "1", 
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 20,
        "complexity": 15,
        "sharpe": 7,
        "feasibility": 8
      }
    },
    {
      "rank": 6,
      "name": "Single_hkjcSplitHandicapEdge",
      "totalScore": 65,
      "grade": "B+",
      "roi": 7.16,
      "totalBets": 871,
      "winRate": 51.7,
      "sharpeRatio": -0.001,
      "recommended": true,
      "tier": "1",
      "scores": {
        "statistical": 0,
        "sampleSize": 20,
        "roi": 20,
        "complexity": 15,
        "sharpe": 0,
        "feasibility": 10
      }
    },
    {
      "rank": 7,
      "name": "Single_atmosphereAdvantage",
      "totalScore": 62,
      "grade": "B",
      "roi": 13.04,
      "totalBets": 58,
      "winRate": 58.6,
      "sharpeRatio": 0.245,
      "recommended": false,
      "tier": "3",
      "scores": {
        "statistical": 0,
        "sampleSize": 10,
        "roi": 20,
        "complexity": 15,
        "sharpe": 7,
        "feasibility": 10
      }
    },
    {
      "rank": 8,
      "name": "Single_giantKilling",
      "totalScore": 60,
      "grade": "B",
      "roi": 13.88,
      "totalBets": 96,
      "winRate": 51.0,
      "sharpeRatio": 0.037,
      "recommended": false,
      "tier": "3",
      "scores": {
        "statistical": 0,
        "sampleSize": 10,
        "roi": 20,
        "complexity": 15,
        "sharpe": 5,
        "feasibility": 10
      }
    },
    {
      "rank": 9,
      "name": "Single_backEarlyAllStrongerFavorites",
      "totalScore": 60,
      "grade": "B",
      "roi": 12.00,
      "totalBets": 66,
      "winRate": 54.5,
      "sharpeRatio": 0.071,
      "recommended": false,
      "tier": "3",
      "scores": {
        "statistical": 0,
        "sampleSize": 10,
        "roi": 20,
        "complexity": 15,
        "sharpe": 5,
        "feasibility": 10
      }
    },
    {
      "rank": 10,
      "name": "Single_underperformingTeam",
      "totalScore": 60,
      "grade": "B",
      "roi": 6.73,
      "totalBets": 169,
      "winRate": 49.7,
      "sharpeRatio": -0.024,
      "recommended": false,
      "tier": "3",
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 20,
        "complexity": 15,
        "sharpe": 0,
        "feasibility": 10
      }
    },
    {
      "rank": 11,
      "name": "Single_sweetSpotUnderdog",
      "totalScore": 60,
      "grade": "B",
      "roi": 6.53,
      "totalBets": 58,
      "winRate": 53.4,
      "sharpeRatio": 0.100,
      "recommended": false,
      "tier": "3",
      "scores": {
        "statistical": 0,
        "sampleSize": 10,
        "roi": 20,
        "complexity": 15,
        "sharpe": 5,
        "feasibility": 10
      }
    },
    {
      "rank": 12,
      "name": "Single_earlySeasonConfusion",
      "totalScore": 57,
      "grade": "B",
      "roi": 26.82,
      "totalBets": 143,
      "winRate": 59.4,
      "sharpeRatio": 0.135,
      "recommended": true,
      "tier": "2",
      "scores": {
        "statistical": 0,
        "sampleSize": 15,
        "roi": 10,
        "complexity": 15,
        "sharpe": 7,
        "feasibility": 10
      }
    }
  ],
  "implementationRecommendations": {
    "tier1": {
      "title": "Immediate Implementation",
      "strategies": ["Single_hkjcSplitHandicapEdge", "Single_alwaysBetAwayTopSix", "Single_awayTopSix"],
      "allocation": "Conservative: 50%/25%/25%, Aggressive: 30%/25%/20%"
    },
    "tier2": {
      "title": "Strong Consideration", 
      "strategies": ["Single_topSixBattle", "Single_ahSlightFavorite", "Single_fadeAllSeasonQuarterFavorites", "Single_earlySeasonConfusion"],
      "allocation": "Aggressive portfolio: 20%/15%/15%/10%"
    },
    "expectedROI": {
      "conservative": "8-10%",
      "aggressive": "10-13%"
    }
  }
        };

        // Helper functions for rankings display
        function getGradeColor(grade) {
            switch(grade) {
                case 'A+': return 'text-green-400';
                case 'A': return 'text-green-300';
                case 'B+': return 'text-blue-400';
                case 'B': return 'text-blue-300';
                case 'C+': return 'text-yellow-400';
                case 'C': return 'text-yellow-300';
                default: return 'text-red-400';
            }
        }

        function getTierColor(tier) {
            switch(tier) {
                case '1': return 'text-green-400 font-bold';
                case '2': return 'text-yellow-400 font-medium';
                default: return 'text-slate-400';
            }
        }

        function getTierText(tier) {
            switch(tier) {
                case '1': return 'Tier 1';
                case '2': return 'Tier 2';
                default: return 'Tier 3';
            }
        }

        // Initialize the page
        loadStrategies();
    </script>
</body>
</html> 